<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>
		<style type="text/css">
			#myCanvas2{
				background: black;
				display:block;
				margin: 0 auto;
			}
		</style>
	</head>
	<body>
		<canvas id="myCanvas2" width="800" height="800">
			您的浏览器不支持canvas，赶快更新版本吧!
		</canvas>
	</body>
	<script type="text/javascript">
		var mc = document.getElementById('myCanvas2');
	    var ctx= mc.getContext('2d');
	    
	    	//计算出鼠标基于canvas的x坐标（绘制白色块及子弹）
	    var mouseX = mc.width/2;
	    var score = 0;//分数
	    var bullArr = [];//子弹数组
	    var enemyArr = [];//掉落物数组
	    var boomArr = [];//爆炸物数组
	    var dieNum = 0;//没被击中且移出画布的掉落物的数量，根据此值判断是否结束游戏
	    var createEnemyTimer;
	    var eleMoveTimer;
	    //封装随机数函数(两个数之间的随机数)
	    function rn(x,y){
	    	return Math.round(Math.random()*(y-x)+x);
	    }
	    
	    function drawStartPage(){
	    	ctx.font = '60px Arial';
	    	ctx.fillStyle = "yellow";
	    	ctx.fillText('飞机大作战',250,400);
	    	
	    	ctx.beginPath();
	    	ctx.font = '50px Arial';
	    	ctx.fillStyle = 'red';
	    	ctx.fillText('点击游戏页面任意位置开始游戏',50,480);
	    	
	    }
	    drawStartPage();
	    
	    //绘制白块
	    function drawBox(){
	    	//判断盒子x值的最大值，不让盒子从画布里出去
	    	if(mouseX > mc.width - 20){
	    		mouseX = mc.width -20;
	    	}
	    	 //判断盒子x值的最小值，不让盒子从画布里出去（只能用if语句，不能用三目）
	    	if(mouseX < 20){
	    		mouseX = 20;
	    	}
	    	ctx.beginPath();
	    	ctx.fillStyle = '#fff';
	    	 ctx.shadowOffsetX = 0; // 设置水平位移
            ctx.shadowOffsetY = 0; // 设置垂直位移
            ctx.shadowBlur = 0; // 设置模糊度
            ctx.shadowColor = 'white'; // 设置阴影颜色
	    	ctx.fillRect(mouseX - 20,730,40,40);
	    	ctx.fill();
	    }
	    
	    
	    //封装子弹类
	    function Bullet(){
	    	 this.x = mouseX - 4;//子弹x坐标
	    	 this.y =722;//子弹y坐标
	    	 this.speed = 2;//子弹匀速移动
	    }
	    Bullet.prototype.move = function(){
	    	this.y -= this.speed;
	    	ctx.beginPath();	    	
	    	ctx.fillStyle = '#fff';
	    	 ctx.shadowOffsetX = 0; // 设置水平位移
            ctx.shadowOffsetY = 0; // 设置垂直位移
            ctx.shadowBlur = 0; // 设置模糊度
            ctx.shadowColor = 'white'; // 设置阴影颜色
	    	ctx.fillRect(this.x,this.y,8,8);
	    	ctx.fill();
	    	//挡子弹移出canvas画布时，从数组中删除，减少不必要的循环，出去的子弹是数组中的第一个元素
	    	if(this.y<0){
	    		bullArr.shift();
	    	}
	    }
	    
	    //创建一个子弹
	    function  createBullet(){
	    	var bullet = new Bullet//实例化子弹
	    bullArr.push(bullet)//将子弹放到子弹数组
	    }
	    
	    /*
	     * Enemy类： 掉落块的类
	     * x,y 左上角的坐标
	     * vx,vy水平方向和竖直方向移动的速度
	     * bc 背景色
	     * dis 左右摇摆的范围
	     */
	    function Enemy(x,wh,vx,vy,bc,dis){
	    	 this.x = x;
	    	 this.y = -wh;
	    	 this.wh = wh;
	    	 this.vx = vx;
	    	 this.vy = vy;
	    	 this.bc = bc;
	    	 this.left  = this.x - dis;//摆动左边边界
	    	 this.right = this.x + dis;//摆动右边的边界 
	    }
	    
	    Enemy.prototype.move = function(){
	    	//当块左右摆动到达边界之后反弹
	    	if(this.x<this.left|| this.x>this.right){
	    		this.vx *= -1;
	    	}
	    	//位置变化
	    	this.x += this.vx;
	    	this.y += this.vy;
	    	//绘制
	    	ctx.beginPath();
	    	ctx.fillStyle = this.bc;
	    	 ctx.shadowOffsetX = 0; // 设置水平位移
         ctx.shadowOffsetY = 0; // 设置垂直位移
         ctx.shadowBlur = 0; // 设置模糊度
         ctx.shadowColor = 'white'; // 设置阴影颜色
	    	ctx.fillRect(this.x,this.y,this.wh,this.wh);
	    	ctx.fill();
	    }
	    
	    //实例化enemy对象函数
	    var minwh= 40,maxwh = 70;//宽高范围
	    var minx = 0,maxx = mc.width - maxwh;//x坐标范围
	    var minvx = -5,maxvx = 3; //x方向速度
	    var minvy = 1,maxvy = 3;//y方向速度范围
	    var mindis = 0,maxdis = 80;//摆动范围
	    function createEnemy(){
	    	var x = rn(minx,maxx);
	    	var wh = rn(minwh,maxwh);
	    	var vx = rn(minvx,maxvx);
	    	var vy = rn(minvy,maxvy);
	    	var dis =rn(mindis,maxdis);
	    	var bc  ='rgb('+rn(30,255)+','+rn(30,255)+','+rn(30,255)+')';
	    	//实例化一个掉落块
	    	var enemy = new Enemy(x,wh,vx,vy,bc,dis);
	    	enemyArr.push(enemy);
	    }
	    
	    //判断小块是否移出画布，移出画布从enemy数组中删除
	    function judgeEnemy(){
	    	for(var i = 0;i<enemyArr.length;i++){
	    		if(enemyArr[i].y>mc.height){
	    			enemyArr.splice(i,1);
	    			dieNum ++;
	    			//移出元素之后数组结构发生变化，为了防止漏判，要让i-1
	    			i--;
	    		}
	    	}
	    }
	    
	    //封装爆炸物类
	    function Boom(x,y,vx,vy,bc){
	    	    this.x = x;//x 
	    	    this.y = y;//y 坐标
	    	    this.vx = vx;//水平方向速度
	    	    this.vy = vy;//垂直方向速度
	    	    this.bc = bc;//背景色
	    	    this.times = 0;//爆炸物的绘制次数(move函数每调一次，time+)
	    }
	    Boom.prototype.move = function(){
	    	    this.x += this.vx;
	    	    this.y +=this.vy;
	    	    ctx.beginPath();
	    	    ctx.fillStyle = this.bc;
	    	    ctx.shadowOffsetX = 0; // 设置水平位移
            ctx.shadowOffsetY = 0; // 设置垂直位移
            ctx.shadowBlur = 50; // 设置模糊度
            ctx.shadowColor = 'yellow'; // 设置阴影颜色
	    	    ctx.fillRect(this.x,this.y,5,5);
	    	    ctx.fill();
	    	    this.times++;
	    }
	    
	    //判断是否击中(碰撞检测)
	    function judegHit(){
	    	 for(var i = 0;i< bullArr.length;i++){
	    	 	for(var j= 0;j<enemyArr.length;j++){
	    	 		var a = bullArr[i];//当前子弹
	    	 		var b = enemyArr[j];//当前掉落块
	    	 		//a和b的碰撞检测
	    	 		if(a.x + 8 > b.x&&a.y+8>b.y&&a.x<b.x+b.wh&&a.y<b.y+b.wh){
	    	 			//分数累加
	    	 			score +=1;
	    	 			//根据被击中的块的信息创建爆炸物
	    	 			createBoom(b.x,b.y,b.wh,b.bc);
	    	 			//两两碰撞
	    	 			bullArr.splice(i,1);//移除子弹
	    	 			enemyArr.splice(j,1);//移除掉落物
	    	 			i--;
	    	 			//当碰撞上的时候，两个块都已经没有作用，删除之后，不用做多余的比较，直接跳出内层循环，让外层循环进行下一次碰撞检测
	    	 			break;
	    	 		}
	    	 	}
	    	 }
	    }
	    
	    //创建爆炸物
	    function createBoom(x,y,wh,bc){
	    	//临时数组，放当前被击中的块产生的那一批爆炸物
	    	var nowArr = [];
	    	//实例化boom
	    	var num = Math.ceil(wh/8);
	    	//双层循环实例化类
	    	for(var i = 0;i<num;i++){
	    		var thisY = y + 8*i;//计算每行的y坐标
	    		for(var j=0;j<num;j++){
	    		var thisX = x + 8*j;
	    		//实例化爆炸物对象
	    		var vx = rn(-3,2);
	    		var vy = rn(-2,3);
	    		if(vx == 0&&vy==0){
	    			vx =-2;
	    			vy= 2;
	    		}
	    		var boom = new Boom(thisX,thisY,vx,vy,bc);
	    		nowArr.push(boom);
	    		}
	    	}
	    	boomArr.push(nowArr);
	    }
	    
	    //判断爆炸物
		function judgeBoom(){
			//[z,z,,z],[x,,x,x],[a,a,a],[d,d,d]
			for(var i=0;i<boomArr.length;i++){
				for(var j =0;j<boomArr[i].length;j++){
					//判断一批爆炸物中移动最慢的是否丛画布中移出
					var maxTimes = Math.ceil(Math.sqrt(Math.pow(mc.height,2)+Math.pow(mc.width,2)));
					if(boomArr[i][j].times > maxTimes){
						boomArr.splice(i,1);
						i--;
						break;
					}
				}
			}
		}
	    
	    //绘制分数
	    function drawScore(){
	    	ctx.beginPath();
	    	ctx.font = '20px Arial';
	    	ctx.fillStyle = 'red';
	    	ctx.fillText(score,20,20);
	    }
	    
	   //游戏开关
	    var gameFlag = 0;// 0:开始游戏 1：绘制子弹 2：游戏结束
	    
	    //为canvas绑定点击事件
	    mc.onclick = function(){
	    	//第一次点击画布
	    	if(gameFlag==0){
	    	
	    	 //为canvas添加鼠标移动时间
	    mc.onmousemove = function(){
	    //计算出鼠标基于canvas的x坐标
	    	var e = event || window.event;
	    	mouseX = e.clientX - mc.offsetLeft;	  
	    	//鼠标移动时绘制白色块
	    	drawBox();
	    }
	     gamestart();
	     gameFlag = 1;
	    }
	    	else if(gameFlag == 1){
	    	createBullet();//创建子弹	
	    	}
	    	else{
	    		gameFlag = 0;
	    		ctx.clearRect(0,0,800,800);
	    		drawStartPage();
	    	}
	    }
	    
	    function gamestart(){
	    //绘制频率
	     eleMoveTimer =setInterval(function(){
	    	 //根据重绘频率清除画布
	    	 ctx.clearRect(0,0,800,800);
	    	  drawBox();
	    	  
	    	   //循环绘制所有子弹
	    	   for(var i=0;i<bullArr.length;i++){
	    	   	bullArr[i].move();
	    	   }
	    	   //循环绘制掉落物
	    	   for(var j=0;j<enemyArr.length;j++){
	    	   	enemyArr[j].move();
//	    	   	console.log(enemyArr);
	    	   }
	    	    	 //绘制爆炸物
	    	 for(var m=0;m<boomArr.length;m++){
	    	 	for(var n = 0;n<boomArr[m].length;n++){
	    	 		boomArr[m][n].move();
	    	 		
	    	 	}
	    	 }
	    	   judgeEnemy();//判断掉落物是否移出画布
	    	   judegHit();//碰撞检测
	    	   judgeBoom();
	    	   drawScore();
	    	   if(dieNum == 1){
	    	   	  gameOver();
	    	   }	    	 
	    },10);
	   
	    	
	     //生成掉落物计时器
	      createEnemyTimer = setInterval(function(){
	     	createEnemy();
	     },1000);
	     }
	    
	    //游戏结束函数
	    function gameOver(){
	    	//清除游戏运行计时器
	    	clearInterval(eleMoveTimer);
	    	clearInterval(createEnemyTimer);
	    	//清除画布的事件
//	    	mc.onclick = null;
	    	mc.onmousemove = null;
	    	ctx.clearRect(0,0,800,800);
	    	
	    	//绘制最终分数
	    	ctx.beginPath();
	    	ctx.font = '50px Arial';
	    	ctx.fillStyle = 'yellow';
	    	ctx.fillText('最终得分：'+ score,280,400);
	    	
	    	//初始所有数据
	    	score = 0;
	    	dieNum = 0;
	    bullArr = [];//子弹数组
	    enemyArr = [];//掉落物数组
	    boomArr = [];//爆炸物数组
         //点击canvas 回到首页
//       mc.onclick = function(){
//       	ctx.clearRect(0,0,800,800);
//       	drawStartPage();
//       }
        gameFlag = 2;
	    }
	</script>
</html>
